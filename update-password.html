<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новый пароль</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- 1. Сначала загружаем Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@^2"></script>
    <!-- 2. Затем загружаем наш скрипт -->
    <script src="js/script.js" defer></script>
</head>
<body>
    <div class="auth-modal show">
        <div class="auth-content">
            <h3>Установите новый пароль</h3>
            <div class="auth-message" id="passwordMessage"></div>
            <form id="passwordForm">
                <input type="password" placeholder="Новый пароль" required minlength="8">
                <input type="password" placeholder="Повторите пароль" required>
                <button type="submit">Сохранить пароль</button>
            </form>
        </div>
    </div>

    <script>
        // Ждем полной загрузки страницы и всех скриптов
        window.addEventListener('DOMContentLoaded', async () => {
            // Проверяем загрузился ли script.js
            if (typeof app === 'undefined') {
                console.error('Ошибка: Основной скрипт не загружен');
                const msg = document.getElementById('passwordMessage');
                if (msg) {
                    msg.textContent = 'Системная ошибка. Пожалуйста, обновите страницу.';
                    msg.className = 'auth-message error';
                }
                return;
            }

            try {
                // Инициализируем Supabase
                await app.initSupabase();
                
                // Проверяем токен восстановления
                const token = localStorage.getItem("sb-recovery-token") || 
                             new URLSearchParams(window.location.search).get('token');
                
                if (!token) {
                    throw new Error("Ссылка для сброса пароля недействительна");
                }

                // Обработка формы
                document.getElementById("passwordForm").addEventListener("submit", async (e) => {
                    e.preventDefault();
                    
                    const form = e.target;
                    const password = form.querySelector('input[type="password"]').value;
                    const confirmPassword = form.querySelectorAll('input[type="password"]')[1].value;
                    const messageElement = document.getElementById("passwordMessage");

                    // Валидация
                    if (password !== confirmPassword) {
                        messageElement.textContent = "Пароли не совпадают";
                        messageElement.className = "auth-message error";
                        return;
                    }

                    try {
                        // Подтверждаем токен
                        const { error: verifyError } = await app.supabase.auth.verifyOtp({
                            type: "recovery",
                            token_hash: token,
                        });

                        if (verifyError) throw verifyError;

                        // Обновляем пароль
                        const { error: updateError } = await app.supabase.auth.updateUser({
                            password: password,
                        });

                        if (updateError) throw updateError;

                        // Успех
                        messageElement.textContent = "Пароль успешно изменён! Перенаправляем...";
                        messageElement.className = "auth-message success";

                        // Очищаем токен
                        localStorage.removeItem("sb-recovery-token");

                        // Перенаправляем через 2 секунды
                        setTimeout(() => {
                            window.location.href = "main.html";
                        }, 2000);
                    } catch (error) {
                        console.error("Ошибка:", error);
                        messageElement.textContent = error.message || "Ошибка при смене пароля";
                        messageElement.className = "auth-message error";
                    }
                });
            } catch (error) {
                console.error("Ошибка инициализации:", error);
                const msg = document.getElementById('passwordMessage');
                if (msg) {
                    msg.textContent = error.message || "Системная ошибка";
                    msg.className = 'auth-message error';
                }
            }
        });
    </script>
</body>
</html>
