<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Новый пароль</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div class="auth-modal show">
      <div class="auth-content">
        <h3>Установите новый пароль</h3>
        <div class="auth-message" id="passwordMessage"></div>
        <form id="passwordForm">
          <input
            type="password"
            placeholder="Новый пароль"
            required
            minlength="8"
          />
          <input type="password" placeholder="Повторите пароль" required />
          <button type="submit">Сохранить пароль</button>
        </form>
      </div>
    </div>
    <script src="js/script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        // Инициализируем Supabase
        await app.initSupabase();

        document
          .getElementById("passwordForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const password = e.target.querySelector(
              'input[type="password"]'
            ).value;
            const confirmPassword = e.target.querySelectorAll(
              'input[type="password"]'
            )[1].value;
            const messageElement = document.getElementById("passwordMessage");

            if (password !== confirmPassword) {
              messageElement.textContent = "Пароли не совпадают";
              messageElement.className = "auth-message error";
              return;
            }

            try {
              // Получаем токен из localStorage
              const token = localStorage.getItem("sb-recovery-token");
              if (!token) throw new Error("Недействительная ссылка");

              // Сначала подтверждаем токен
              const { error: verifyError } = await app.supabase.auth.verifyOtp({
                type: "recovery",
                token_hash: token,
              });

              if (verifyError) throw verifyError;

              // Затем обновляем пароль
              const { error: updateError } = await app.supabase.auth.updateUser(
                {
                  password: password,
                }
              );

              if (updateError) throw updateError;

              messageElement.textContent =
                "Пароль успешно изменён! Вы будете перенаправлены...";
              messageElement.className = "auth-message success";

              // Очищаем токен
              localStorage.removeItem("sb-recovery-token");

              setTimeout(() => {
                window.location.href = "main.html";
              }, 2000);
            } catch (error) {
              console.error("Ошибка смены пароля:", error);
              messageElement.textContent =
                "Ошибка: " + (error.message || "Не удалось изменить пароль");
              messageElement.className = "auth-message error";
            }
          });
      });
    </script>
  </body>
</html>
