<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новый пароль</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Загружаем Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@^2"></script>
    <!-- Загружаем наш скрипт синхронно -->
    <script src="js/script.js"></script>
</head>
<body>
    <div class="auth-modal show">
        <div class="auth-content">
            <h3>Установите новый пароль</h3>
            <div class="auth-message" id="passwordMessage"></div>
            <form id="passwordForm">
                <input type="password" placeholder="Новый пароль" required minlength="8">
                <input type="password" placeholder="Повторите пароль" required>
                <button type="submit">Сохранить пароль</button>
            </form>
        </div>
    </div>

    <script>
    // Ждём полной загрузки страницы
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('DOM fully loaded');
        
        // Проверяем доступность app
        if (!window.app) {
            console.error('App object not available - retrying...');
            // Пробуем перезагрузить скрипт
            const script = document.createElement('script');
            script.src = 'js/script.js';
            document.head.appendChild(script);
            
            // Даём время на загрузку
            setTimeout(() => {
                if (!window.app) {
                    showError('Системная ошибка. Пожалуйста, обновите страницу.');
                    return;
                }
                initializePasswordReset();
            }, 500);
            return;
        }
        
        initializePasswordReset();
    });

    async function initializePasswordReset() {
        try {
            console.log('Initializing password reset...');
            
            // 1. Инициализируем Supabase
            if (!app.supabase) {
                await app.initSupabase();
            }
            
            // 2. Получаем токен из URL или localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token') || localStorage.getItem('sb-recovery-token');
            
            if (!token) {
                throw new Error('Ссылка для сброса пароля недействительна или устарела');
            }
            
            // 3. Настраиваем обработчик формы
            document.getElementById('passwordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const form = e.target;
                const password = form.querySelector('input[type="password"]').value;
                const confirmPassword = form.querySelectorAll('input[type="password"]')[1].value;
                
                if (password !== confirmPassword) {
                    showError('Пароли не совпадают');
                    return;
                }
                
                if (password.length < 8) {
                    showError('Пароль должен содержать минимум 8 символов');
                    return;
                }
                
                try {
                    // 4. Проверяем токен
                    console.log('Verifying token...');
                    const { error: verifyError } = await app.supabase.auth.verifyOtp({
                        type: "recovery",
                        token_hash: token
                    });
                    
                    if (verifyError) throw verifyError;
                    
                    // 5. Обновляем пароль
                    console.log('Updating password...');
                    const { error: updateError } = await app.supabase.auth.updateUser({
                        password: password
                    });
                    
                    if (updateError) throw updateError;
                    
                    // 6. Успех - очищаем и перенаправляем
                    showSuccess('Пароль успешно изменён! Перенаправляем...');
                    localStorage.removeItem('sb-recovery-token');
                    
                    setTimeout(() => {
                        window.location.href = 'main.html';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Password update error:', error);
                    showError(error.message || 'Ошибка при изменении пароля');
                }
            });
            
        } catch (error) {
            console.error('Initialization error:', error);
            showError(error.message || 'Системная ошибка инициализации');
        }
    }

    // Вспомогательные функции
    function showError(message) {
        const el = document.getElementById('passwordMessage');
        if (el) {
            el.textContent = message;
            el.className = 'auth-message error';
        }
    }
    
    function showSuccess(message) {
        const el = document.getElementById('passwordMessage');
        if (el) {
            el.textContent = message;
            el.className = 'auth-message success';
        }
    }
    </script>
</body>
</html>
